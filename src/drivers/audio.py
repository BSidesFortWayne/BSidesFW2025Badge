import asyncio
import machine

AUDIO_STOPPED = 0
AUDIO_PLAYING = 1
AUDIO_PAUSED = 2

class Speaker:
    def __init__(self):
        self.pwm_pin = machine.Pin(15)
        self.pwm = machine.PWM(self.pwm_pin)

        self.pwm.duty(0)

        self.speed = 1

        self.state = AUDIO_STOPPED
    

    def resume_song(self):
        self.state = AUDIO_PLAYING

    def start_tetris(self):
        self.start_song(get_tetris_song())

    def start_song(self, song):
        # TODO need to set the state to stopped and wait for the old thread to exit
        # before starting a new one... 
        # _thread.start_new_thread(self._play_song, (song,))
        asyncio.create_task(self._play_song(song))

    def pause_song(self):
        self.state = AUDIO_PAUSED

    async def _play_song(self, song, repeat=False):
        self.duration = self.get_song_duration(song)
        print(f"Song Duration Is: {self.duration}")
        self.state = AUDIO_PLAYING
        while self.state:
            for note, duration in song:
                if note != 'R':
                    self.pwm.freq(int(note/2))
                    self.pwm.duty(30)
                else:
                    self.pwm.duty(0)

                await asyncio.sleep(duration / self.speed)
                self.pwm.duty(0)
                await asyncio.sleep(0.01)
                if self.state == AUDIO_PAUSED:
                    while self.state == AUDIO_PAUSED:
                        await asyncio.sleep(0.1)
            if not repeat:
                break
        self.state = AUDIO_STOPPED


    def get_song_duration(self, song):
        duration = 0
        for _, d in song:
            duration += d
        return duration
    
def get_tetris_song():
    return [(659.2551138257398, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.2142855), (659.2551138257398, 0.10714275), (587.3295358348151, 0.10714275), (523.2511306011972, 0.2142855), (493.8833012561241, 0.2142855), (440.0, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.6428564999999999), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (4470.0, 0.857142), (587.3295358348151, 0.428571), (698.4564628660078, 0.2142855), (880.0, 0.428571), (783.9908719634985, 0.2142855), (698.4564628660078, 0.2142855), (659.2551138257398, 0.6428564999999999), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.428571), (659.2551138257398, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.2142855), (659.2551138257398, 0.10714275), (587.3295358348151, 0.10714275), (523.2511306011972, 0.2142855), (493.8833012561241, 0.2142855), (440.0, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.6428564999999999), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.857142), (587.3295358348151, 0.428571), (698.4564628660078, 0.2142855), (880.0, 0.428571), (783.9908719634985, 0.2142855), (698.4564628660078, 0.2142855), (659.2551138257398, 0.6428564999999999), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.428571), (329.6275569128699, 0.857142), (261.6255653005986, 0.857142), (293.6647679174076, 0.857142), (246.94165062806206, 0.857142), (261.6255653005986, 0.857142), (220.0, 0.857142), (207.65234878997256, 0.857142), (246.94165062806206, 0.428571), (329.6275569128699, 0.857142), (261.6255653005986, 0.857142), (293.6647679174076, 0.857142), (246.94165062806206, 0.857142), (261.6255653005986, 0.428571), (329.6275569128699, 0.428571), (440.0, 0.857142), (415.3046975799451, 0.857142), (659.2551138257398, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.2142855), (659.2551138257398, 0.10714275), (587.3295358348151, 0.10714275), (523.2511306011972, 0.2142855), (493.8833012561241, 0.2142855), (440.0, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.6428564999999999), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.857142), (587.3295358348151, 0.428571), (698.4564628660078, 0.2142855), (880.0, 0.428571), (783.9908719634985, 0.2142855), (698.4564628660078, 0.2142855), (659.2551138257398, 0.6428564999999999), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.428571), (659.2551138257398, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.2142855), (659.2551138257398, 0.10714275), (587.3295358348151, 0.10714275), (523.2511306011972, 0.2142855), (493.8833012561241, 0.2142855), (440.0, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.6428564999999999), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.857142), (587.3295358348151, 0.428571), (698.4564628660078, 0.2142855), (880.0, 0.428571), (783.9908719634985, 0.2142855), (698.4564628660078, 0.2142855), (659.2551138257398, 0.6428564999999999), (523.2511306011972, 0.2142855), (659.2551138257398, 0.428571), (587.3295358348151, 0.2142855), (523.2511306011972, 0.2142855), (493.8833012561241, 0.428571), (493.8833012561241, 0.2142855), (523.2511306011972, 0.2142855), (587.3295358348151, 0.428571), (659.2551138257398, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (440.0, 0.428571), (493.8833012561241, 0.428571), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.2142855), (440.0, 0.2142855), (523.2511306011972, 0.428571), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (329.6275569128699, 0.428571), (329.6275569128699, 0.857142), (349.2282314330039, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (523.2511306011972, 0.10714275), (523.2511306011972, 0.10714275), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (391.99543598174927, 0.6428564999999999), (329.6275569128699, 0.2142855), (391.99543598174927, 0.2142855), (440.0, 0.10714275), (391.99543598174927, 0.10714275), (349.2282314330039, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.2142855), (415.3046975799451, 0.2142855), (523.2511306011972, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (329.6275569128699, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.428571), (493.8833012561241, 0.428571), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.2142855), (440.0, 0.2142855), (523.2511306011972, 0.428571), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (329.6275569128699, 0.428571), (329.6275569128699, 0.857142), (349.2282314330039, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (523.2511306011972, 0.10714275), (523.2511306011972, 0.10714275), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (391.99543598174927, 0.6428564999999999), (329.6275569128699, 0.2142855), (391.99543598174927, 0.2142855), (440.0, 0.10714275), (391.99543598174927, 0.10714275), (349.2282314330039, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.2142855), (415.3046975799451, 0.2142855), (523.2511306011972, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (329.6275569128699, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.428571), (261.6255653005986, 0.857142), (220.0, 0.857142), (246.94165062806206, 0.857142), (207.65234878997256, 0.857142), (220.0, 0.857142), (207.65234878997256, 0.428571), (261.6255653005986, 0.857142), (220.0, 0.857142), (246.94165062806206, 0.857142), (207.65234878997256, 0.857142), (220.0, 0.428571), (261.6255653005986, 0.428571), (329.6275569128699, 0.857142), (293.6647679174076, 0.857142), (493.8833012561241, 0.428571), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.2142855), (440.0, 0.2142855), (523.2511306011972, 0.428571), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (329.6275569128699, 0.428571), (329.6275569128699, 0.857142), (349.2282314330039, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (523.2511306011972, 0.10714275), (523.2511306011972, 0.10714275), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (391.99543598174927, 0.6428564999999999), (329.6275569128699, 0.2142855), (391.99543598174927, 0.2142855), (440.0, 0.10714275), (391.99543598174927, 0.10714275), (349.2282314330039, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.2142855), (415.3046975799451, 0.2142855), (523.2511306011972, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (329.6275569128699, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.428571), (493.8833012561241, 0.428571), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.2142855), (440.0, 0.2142855), (523.2511306011972, 0.428571), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.428571), (523.2511306011972, 0.428571), (440.0, 0.428571), (329.6275569128699, 0.428571), (329.6275569128699, 0.857142), (349.2282314330039, 0.428571), (440.0, 0.2142855), (523.2511306011972, 0.2142855), (523.2511306011972, 0.10714275), (523.2511306011972, 0.10714275), (493.8833012561241, 0.2142855), (440.0, 0.2142855), (391.99543598174927, 0.6428564999999999), (329.6275569128699, 0.2142855), (391.99543598174927, 0.2142855), (440.0, 0.10714275), (391.99543598174927, 0.10714275), (349.2282314330039, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (329.6275569128699, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (493.8833012561241, 0.2142855), (415.3046975799451, 0.2142855), (523.2511306011972, 0.2142855), (415.3046975799451, 0.2142855), (440.0, 0.2142855), (329.6275569128699, 0.2142855), (329.6275569128699, 0.428571), (329.6275569128699, 0.428571), (32.70319566257483, 0.2142855), (32.70319566257483, 0.2142855), (32.70319566257483, 0.2142855), (32.70319566257483, 0.2142855)]
